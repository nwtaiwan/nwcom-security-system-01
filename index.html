<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>西北保全勤務管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, setPersistence, browserSessionPersistence, browserLocalPersistence, signInWithEmailAndPassword, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- START: Firebase Initialization and Authentication ---
        
        // SECURITY WARNING: Do not hardcode your API keys in production code.
        // The __firebase_config variable is injected by the environment for security.
        // The config below is for local development reference ONLY.
        // 安全警告：請勿在正式環境的程式碼中寫死您的 API 金鑰。
        // __firebase_config 變數會由執行環境安全地注入。
        // 下方的設定僅供本機開發參考。
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        // Initialize Firebase
        // 初始化 Firebase
        const app = initializeApp(JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(firebaseConfig)));
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- DOM Elements ---
        const loginPage = document.getElementById('loginPage');
        const adminDashboard = document.getElementById('adminDashboard');
        const loginForm = document.getElementById('loginForm');
        const logoutButton = document.getElementById('logoutButton');
        const userNameDisplay = document.getElementById('userName');
        const rememberMeCheckbox = document.getElementById('rememberMe');
        const allLinks = document.querySelectorAll('#sidebar nav a');
        const messageBoxContainer = document.getElementById('messageBoxContainer');
        const messageBoxText = document.getElementById('messageBoxText');
        
        // --- Settings Page DOM Elements ---
        const addRegionButton = document.getElementById('addRegionButton');
        const newRegionInput = document.getElementById('newRegionInput');
        const regionList = document.getElementById('regionList');

        // --- App State ---
        let regions = [];
        let committeeTitles = [];
        let employeeTitles = [];
        let licenses = [];
        
        // --- Utility Functions ---
        
        // Function to show a message to the user
        // 顯示訊息給使用者的函式
        function showMessage(message, isError = false) {
            if (messageBoxText) {
                messageBoxText.textContent = message;
                // You can add styling for errors if you want
                // 您可以根據需要為錯誤添加樣式
                // messageBoxText.className = isError ? 'text-red-500' : 'text-gray-800';
            }
            if (messageBoxContainer) {
                messageBoxContainer.classList.remove('hidden');
                setTimeout(() => {
                    messageBoxContainer.classList.add('hidden');
                }, 3000); // Hide after 3 seconds
            }
        }

        // --- Authentication Logic ---

        // Listen for authentication state changes
        // 監聽身份驗證狀態的變化
        onAuthStateChanged(auth, user => {
            if (user && !user.isAnonymous) {
                // User is signed in, fetch their role and setup the dashboard
                // 用戶已登入，獲取其角色並設定儀表板
                console.log("已登入使用者:", user.uid);
                fetchUserRoleAndLogin(user);
            } else {
                // User is signed out or is an anonymous user
                // 用戶已登出或是匿名用戶
                console.log("使用者已登出或為匿名狀態");
                showLoginPage();
            }
        });

        // Handle initial authentication token
        // 處理初始身份驗證令牌
        (async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Custom token sign-in successful.");
                } else if (!auth.currentUser) {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
            } catch (error) {
                console.error("Initial authentication failed:", error);
                showMessage("系統初始化失敗，請稍後再試。", true);
            }
        })();

        // Login form submission handler
        // 登入表單提交處理
        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const rememberMe = rememberMeCheckbox.checked;

                try {
                    // Set auth persistence based on "Remember Me"
                    // 根據“記住我”設置身份驗證持久性
                    const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
                    await setPersistence(auth, persistence);
                    
                    console.log("正在嘗試使用以下方式登入:", email);
                    await signInWithEmailAndPassword(auth, email, password);
                    // onAuthStateChanged will handle the rest
                    // onAuthStateChanged 將處理剩下的邏輯
                } catch (error) {
                    console.error("登入失敗:", error.code, error.message);
                    if (error.code === 'auth/operation-not-allowed') {
                        showMessage('登入失敗：請先在 Firebase 後台啟用 Email/Password 登入方式。', true);
                    } else {
                        showMessage('帳號或密碼錯誤，請重新輸入。', true);
                    }
                }
            });
        }

        // Logout button click handler
        // 登出按鈕點擊處理
        if (logoutButton) {
            logoutButton.addEventListener('click', () => {
                signOut(auth).catch(error => {
                    console.error("登出時發生錯誤:", error);
                    showMessage("登出時發生錯誤，請稍後再試。", true);
                });
            });
        }
        
        // Fetch user role from Firestore and proceed with login
        // 從 Firestore 獲取用戶角色並繼續登入
        async function fetchUserRoleAndLogin(user) {
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users`, user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    console.log("成功獲取使用者資料:", userData);
                    setupDashboardForRole(userData);
                    showDashboardPage();
                } else {
                    // This is a valid scenario if a user is created in Firebase Auth but their profile document hasn't been created in Firestore yet.
                    // The user cannot proceed without a defined role.
                    // 這種情況是正常的，例如當一個使用者在 Firebase Auth 中被建立，但其設定檔尚未在 Firestore 中建立時。
                    // 沒有定義角色的使用者無法繼續操作。
                    console.warn(`登入中止：使用者 (UID: ${user.uid}) 已通過驗證，但在 Firestore 中找不到其角色設定檔。如果此使用者應有權限，請在 'artifacts/${appId}/users/${user.uid}' 路徑下建立文件並設定 'role' 欄位。`);
                    showMessage("您的帳號尚未啟用或權限設定不完整，請聯絡系統管理員。", true);
                    signOut(auth); // Log out the user as they can't proceed
                }
            } catch (error) {
                console.error("讀取 Firestore 使用者資料時發生嚴重錯誤:", error);
                showMessage("讀取使用者資料時發生錯誤，請稍後再試。", true);
                signOut(auth);
            }
        }

        // --- UI Control and Role-Based Access Control (RBAC) ---
        
        // Show login page and hide dashboard
        // 顯示登入頁面並隱藏儀表板
        function showLoginPage() {
            if (adminDashboard) adminDashboard.classList.add('hidden');
            if (loginPage) loginPage.classList.remove('hidden');
            document.body.className = 'bg-red-700 flex items-center justify-center min-h-screen p-4';
        }

        // Show dashboard and hide login page
        // 顯示儀表板並隱藏登入頁面
        function showDashboardPage() {
            if (loginPage) loginPage.classList.add('hidden');
            if (adminDashboard) adminDashboard.classList.remove('hidden');
            document.body.className = '';
            // Navigate to the dashboard view by default
            // 預設導航到儀表板視圖
            // showView('dashboard'); // Assuming showView function exists
        }
        
        // Setup dashboard UI based on user role
        // 根據使用者角色設定儀表板界面
        function setupDashboardForRole(userData) {
            if (userNameDisplay) {
                userNameDisplay.textContent = userData.name || userData.email;
            }
            const userRole = userData.role;
            console.log(`正在為角色設定儀表板: ${userRole}`);

            // A map defining which roles can see which links
            // 定義哪些角色可以看到哪些連結的地圖
            const permissions = {
                dashboardLink: ['admin', 'manager', 'junior_manager', 'employee'],
                accountLink: ['admin', 'manager'],
                communityLink: ['admin', 'manager', 'junior_manager'],
                scheduleLink: ['admin', 'manager', 'junior_manager'],
                rewardsLink: ['admin', 'manager', 'junior_manager'],
                tasksLink: ['admin', 'manager', 'junior_manager'],
                reportsLink: ['admin', 'manager'],
                settingsLink: ['admin']
            };

            // Loop through all links and check permissions
            // 遍歷所有連結並檢查權限
            allLinks.forEach(link => {
                const linkId = link.id;
                if (permissions[linkId] && permissions[linkId].includes(userRole)) {
                    link.style.display = 'flex'; // Show link
                } else {
                    link.style.display = 'none'; // Hide link
                }
            });
        }
        
        // --- Firestore Data Management for Settings ---
        
        const settingsDocRef = doc(db, `artifacts/${appId}/public/data/settings/company`);
        
        // Load settings data from Firestore
        // 從 Firestore 加載設定數據
        async function loadSettings() {
            try {
                const docSnap = await getDoc(settingsDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log("從 Firestore 加載的設定:", data);
                    // Update local arrays with data from Firestore
                    // 使用來自 Firestore 的數據更新本地數組
                    regions = data.regions || [];
                    committeeTitles = data.committeeTitles || [];
                    employeeTitles = data.employeeTitles || [];
                    licenses = data.licenses || [];
                } else {
                    console.log("在 Firestore 中找不到設定文件，將使用預設值。");
                    // If no settings exist, maybe save the default ones?
                    // 如果不存在設定，也許可以保存預設值？
                    saveSettings();
                }
            } catch (error) {
                console.error("加載設定時出錯:", error);
                showMessage("無法加載系統設定。", true);
            } finally {
                // Render lists regardless of success or failure (shows defaults on fail)
                // 無論成功或失敗都渲染列表（失敗時顯示預設值）
                renderAllLists();
            }
        }

        // Save (or update) settings data to Firestore
        // 將設定數據保存（或更新）到 Firestore
        async function saveSettings() {
            try {
                await setDoc(settingsDocRef, {
                    regions: regions,
                    committeeTitles: committeeTitles,
                    employeeTitles: employeeTitles,
                    licenses: licenses
                });
                console.log("設定已成功保存到 Firestore。");
                showMessage("設定已儲存！");
            } catch (error) {
                console.error("保存設定時出錯:", error);
                showMessage("儲存設定失敗。", true);
            }
        }
        
        // --- Settings Rendering Functions ---
        function renderRegionList() {
            if (!regionList) return;
            regionList.innerHTML = regions.map(r => `
                <li class="flex justify-between items-center p-2 bg-gray-50 rounded">
                    <span>${r}</span>
                    <button class="remove-btn text-red-500 hover:text-red-700" data-name="${r}" data-type="region">&times;</button>
                </li>
            `).join('');
        }
        
        function renderAllLists() {
            renderRegionList();
            // Call other render functions here when they are created
            // ... renderEmployeeTitleList();
        }

        // Add new item logic now calls saveSettings
        // 新增項目的邏輯現在會調用 saveSettings
        if (addRegionButton) {
            addRegionButton.addEventListener('click', () => {
                const newRegion = newRegionInput.value.trim();
                if (newRegion && !regions.includes(newRegion)) {
                    regions.push(newRegion);
                    renderRegionList();
                    saveSettings(); // Save to Firestore
                    newRegionInput.value = '';
                }
            });
        }
        // ... (similar updates for addEmployeeTitleButton, addLicenseButton, addCommitteeTitleButton)

        // Remove item logic now calls saveSettings
        // 刪除項目的邏輯現在會調用 saveSettings
        document.body.addEventListener('click', (e) => {
            if (e.target.closest('.remove-btn')) {
                const btn = e.target.closest('.remove-btn');
                const nameToRemove = btn.dataset.name;
                const type = btn.dataset.type;
                let changed = false;
                if (type === 'region') {
                    regions = regions.filter(r => r !== nameToRemove);
                    renderRegionList();
                    changed = true;
                } 
                // ... (other types)
                
                if (changed) {
                    saveSettings(); // Save to Firestore
                }
            }
        });

        // Initial call to load settings when the app starts
        // 應用程式啟動時初始調用以加載設定
        loadSettings();

        // Password visibility toggle
        const togglePassword = document.getElementById('togglePassword');
        if (togglePassword) {
            togglePassword.addEventListener('click', function (e) {
                const password = document.getElementById('password');
                const eyeIcon = document.getElementById('eyeIcon');
                const eyeOffIcon = document.getElementById('eyeOffIcon');
                const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
                password.setAttribute('type', type);
                eyeIcon.classList.toggle('hidden');
                eyeOffIcon.classList.toggle('hidden');
            });
        }
        
    </script>
    
    <style>
        /* ... (existing styles) ... */
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        .dashboard-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        #togglePassword {
            cursor: pointer;
        }
        .message-box-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .message-box {
            background: white;
            color: #333;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-size: 1rem;
        }
        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-box {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            text-align: center;
            position: relative;
            max-height: 90%;
            overflow-y: auto;
            width: 600px;
        }
        .modal-box .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #ef4444;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-red-700 flex items-center justify-center min-h-screen p-4">

    <!-- Login Page (登入頁面) -->
    <div id="loginPage" class="w-full max-w-md">
        <div class="bg-white shadow-lg rounded-xl px-8 pt-6 pb-8 mb-4">
            <div class="text-center mb-8">
                <img src="https://static.wixstatic.com/media/6148f9_56377cef73c1498f95a2c3057b89f2ed~mv2.png" alt="系統Logo" class="w-[100px] h-[50px] object-contain mx-auto mb-4">
                <h1 class="text-2xl font-bold text-gray-700">西北保全勤務管理系統</h1>
                <p class="text-gray-500">V1.1.2</p>
            </div>
            <form id="loginForm">
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-gray-700 text-sm font-bold" for="email">
                            帳號 (Email)
                        </label>
                        <div class="flex items-center">
                            <input id="rememberMe" name="remember-me" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-red-600 focus:ring-red-500">
                            <label for="rememberMe" class="ml-2 block text-sm text-gray-700">
                                記住我
                            </label>
                        </div>
                    </div>
                    <input class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-red-500" id="email" type="email" placeholder="請輸入您的登入信箱">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="password">
                        密碼
                    </label>
                    <div class="relative">
                        <input class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 pr-10 leading-tight focus:outline-none focus:ring-2 focus:ring-red-500" id="password" type="password" placeholder="******************">
                        <div id="togglePassword" class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5">
                            <svg id="eyeIcon" class="h-6 w-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            <svg id="eyeOffIcon" class="h-6 w-6 text-gray-500 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 1.274-4.057 5.064 7 9.542 7 .847 0 1.67 .126 2.454 .364m-6.082 11.45a1 1 0 01-1.414-1.414l11.03-11.03a1 1 0 011.414 1.414l-11.03 11.03zM15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </div>
                    </div>
                </div>
                <div class="flex items-center justify-between mt-4">
                    <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg w-full focus:outline-none focus:shadow-outline" type="submit">
                        登入
                    </button>
                </div>
            </form>
        </div>
        <p class="text-center text-gray-200 text-xs">
            &copy;2025 西北保全股份有限公司. All rights reserved.
        </p>
    </div>

    <!-- Admin Dashboard (管理員儀表板) -->
    <div id="adminDashboard" class="hidden w-full h-screen">
        <!-- This is a placeholder for the full dashboard HTML -->
        <!-- 這裡是儀表板完整HTML的佔位符 -->
        <div class="flex h-full bg-gray-100">
            <!-- Sidebar (側邊欄) -->
            <div id="sidebar" class="w-64 bg-white shadow-md flex flex-col">
                <div class="p-6 text-center border-b">
                    <img src="https://static.wixstatic.com/media/6148f9_56377cef73c1498f95a2c3057b89f2ed~mv2.png" alt="系統Logo" class="w-24 mx-auto mb-2">
                    <h2 class="text-xl font-semibold">管理系統</h2>
                    <p id="userRoleDisplay" class="text-sm text-gray-500">系統管理員</p>
                </div>
                <nav class="flex-1 px-4 py-6 space-y-2">
                    <a href="#" id="dashboardLink" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">儀表板</a>
                    <a href="#" id="accountLink" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">帳號管理</a>
                    <a href="#" id="communityLink" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">社區管理</a>
                    <a href="#" id="scheduleLink" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">勤務排班</a>
                    <a href="#" id="rewardsLink" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">獎懲事件</a>
                    <a href="#" id="tasksLink" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">任務指派</a>
                    <a href="#" id="reportsLink" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">報告與分析</a>
                    <a href="#" id="settingsLink" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">系統設定</a>
                </nav>
                <div class="mt-auto p-4 border-t">
                    <button id="logoutButton" class="w-full flex items-center justify-center px-4 py-2 text-gray-600 hover:bg-red-100 hover:text-red-600 rounded-lg">
                       登出
                    </button>
                </div>
            </div>

            <!-- Main Content (主要內容) -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <header class="bg-white shadow-sm p-4 flex justify-between items-center">
                    <h1 id="viewTitle" class="text-2xl font-semibold text-gray-800">儀表板</h1>
                     <div class="flex items-center">
                        <span id="userName" class="text-gray-600">Admin</span>
                        <img class="w-10 h-10 rounded-full ml-3" src="https://placehold.co/40x40/7C3AED/FFFFFF?text=A" alt="Admin Avatar">
                    </div>
                </header>
                <main id="mainContent" class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                    <!-- Content for different views will be injected here -->
                    <!-- 不同視圖的內容將在此處注入 -->
                </main>
            </div>
        </div>
    </div>
    
    <!-- Message Box (訊息框) -->
    <div id="messageBoxContainer" class="message-box-container hidden">
        <div id="messageBox" class="message-box">
            <p id="messageBoxText"></p>
        </div>
    </div>

    <!-- Modals (彈出視窗) -->
    <div id="addCommunityModal" class="modal-container hidden">
        <!-- ... existing community modal code ... -->
    </div>
    <div id="addEmployeeModal" class="modal-container hidden">
        <!-- ... existing employee modal code ... -->
    </div>

</body>
</html>
